<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: common/c.ajax.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: common/c.ajax.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 封装常用的Ajax 访问
 * @namespace cAjax
 * @date 2013年6月23日
 */
 //, 'cUtilPerformance'  , cperformance
define([
  "data/store/c.common.store"
], function (CommonStore) {
  "use strict";
  //为兼容Kai2.0, json去掉charset=utf-8
  var contentTypeMap = {
    'json': 'application/json',
    'jsonp': 'application/json'
  };
  var userStore = CommonStore.UserStore.getInstance();

  /**/
  var _getContentType = function (contentType) {
    if (contentType) {
      contentType = contentTypeMap[contentType] ? contentTypeMap[contentType] : contentType;
    }
    return contentType;
  };

  /**
   *  AJAX GET方式访问接口
   * @method cAjax.get
   * @param {string} url 请求的url
   * @param {object} data json格式的数据
   * @param {function} successCallback 成功回调
   * @param {function} [errorCallback] 错误回调
   * @param {number} [timeout=30000] 超时时间
   * @returns {XMLHttpRequest} XMLHttpRequest ajax句柄
   */
  function get(url, data, callback, error, timeout) {
    var opt = _getCommonOpt(url, data, callback, error);
    opt.type = 'GET';
    opt.timeout = timeout;
    return _sendReq(opt);
  }

  /**
   * AJAX POST方式访问接口
   * @method cAjax.post
   * @param {string} url 请求的url
   * @param {object} data json格式的数据
   * @param {function} successCallback 成功回调
   * @param {function} [errorCallback] 错误回调
   * @param {number} [timeout=30000] 超时时间
   * @returns {XMLHttpRequest} XMLHttpRequest ajax句柄
   */
  function post(url, data, callback, error,timout) {
    var contentType = data.contentType;
    data = JSON.stringify(data);
    var opt = _getCommonOpt(url, data, callback, error);
    opt.type = 'POST';
    opt.dataType = 'json';
    opt.timeout = timout;
    opt.contentType = _getContentType(contentType) || 'application/json';
    return _sendReq(opt);
  }

  /**
   * 以JSONP方式跨域访问外部接口
   * @method cAjax.jsonp
   * @param {string} url 请求的url
   * @param {object} data json格式的数据
   * @param {function} successCallback 成功回调
   * @param {function} [errorCallback] 错误回调
   * @param {number} [timeout=30000] 超时时间
   * @returns {XMLHttpRequest} XMLHttpRequest ajax句柄
   */
  function jsonp(url, data, callback, error,timeout) {
    var opt = _getCommonOpt(url, data, callback, error);
    opt.type = 'GET';
    opt.dataType = 'jsonp';
    opt.crossDomain = true;
    opt.timeout = timeout;
    return _sendReq(opt);
  }

  /**
   * Cros方法提交Ajax请求
   * @method cAjax.cros
   * @param {string} url 请求的url
   * @param {string} [type=POST] 请求提交方式 POST|GET
   * @param {object} data json格式的数据
   * @param {function} successCallback 成功回调
   * @param {function} [errorCallback] 错误回调
   * @param {number} [timeout=30000] 超时时间
   * @returns {XMLHttpRequest} XMLHttpRequest ajax句柄
   */
  function cros(url, type, data, callback, error,timeout) {
    var contentType = data.contentType;

    if (type.toLowerCase() !== 'get') {
      data = JSON.stringify(data);
    }
    var opt = _getCommonOpt(url, data, callback, error);
    opt.type = type;
    opt.dataType = 'json';
    opt.crossDomain = true;
    opt.data = data;
    opt.contentType = _getContentType(contentType) || 'application/json';
    opt.timeout = timeout;
    //opt.timeout = 90000;//TBD 为了测试黑名单接口 暂时设置为3分钟，后续需要修改
    /* if (window.XDomainRequest) {
     return _iecros(opt);
     } else {*/
    return _sendReq(opt);
    //}
  }

  /**
   * AJAX 提交表单,不能跨域
   * @method cAjax.form
   * @param {url} url
   * @param {Object} form 可以是dom对象，dom id 或者jquery 对象
   * @param {function} callback 回调
   * @param {function} error 可选
   */
  function form(url, formdata, callback, error) {
    var jdom = null, data = '';
    if (typeof formdata == 'string') {
      jdom = $('#' + formdata);
    } else {
      jdom = $(formdata);
    }
    if (jdom &amp;&amp; jdom.length > 0) {
      data = jdom.serialize();
    }
    var opt = _getCommonOpt(url, data, callback, error);
    return _sendReq(opt);
  }

  function updateInterfaceState(state){
    Kai._interfaceStatesStore.get(state.url).then(function(requestRecord){
      requestRecord.costTime = state.statusChangeTime - requestRecord.requestTime;//耗时
      if(requestRecord.costTime >= 2000){//记录超过2秒返回的接口
        _.extend(requestRecord,state);
        Kai._interfaceStatesStore.put(requestRecord);//更新状态记录
      }else{
        Kai._interfaceStatesStore.remove(state.url);//删除请求纪录
      }
    },function(){

    });
  }


  /*
  发送post请求
  or
  跨越请求
  */
  function _sendReq(opt) {
    //TBD var uuidXhrSend = cperformance.getUuid();
    /*TBD cperformance.group(uuidXhrSend, {
      name: "AjaxReady",
      url: opt.url,
      data: opt.data
    });*/

    //+…2014-08-19
    var loadedLength = 0;


    //设置请求参数
    var obj = {
      url: opt.url,
      type: opt.type,
      dataType: opt.dataType,
      data: opt.data,
      contentType: opt.contentType,
      timeout: opt.timeout || Kai.timeout || 50000,

      //+…2014-08-19
      // 获取响应的字节长度（responseText.length 系字符数）
      beforeSend: function (xhr) {
        xhr.onprogress = function (event) {
          loadedLength = event.loaded ? event.loaded : event.position;
        };
        var requestData;
        try{
          requestData = JSON.parse(opt.data);
        }catch(e){
          requestData = opt.data;
        }

        if(_.isObject(requestData)){// &amp;&amp; requestData.requestHead
          var userInfo = userStore.get() || {};
          var auth = '';
          if(requestData.requestHead){
            auth = requestData.requestHead['X-Sso-Token'] ||'';//增加X-Sso_token
          }else{
            auth = userInfo.auth  ||  '';
          }
          xhr.setRequestHeader("X-Sso-Token", auth);
          //xhr.widthCredentials = true;
          /*
          if(Kai.getQuery().graytestcode){
            xhr.setRequestHeader("grayTestCode", Kai.getQuery().graytestcode);
          }
          */
        }
      },

      //-1…2014-08-19
      // success: function (res) {
      //+1…2014-08-19
      success: function (res, status, xhr) {
        //+5…2014-08-19

        /*cperformance.log({
          name: 'AjaxMessageSize',
          // contentEncoding: xhr &amp;&amp; typeof xhr.getResponseHeader == 'function' ? xhr.getResponseHeader('content-encoding') : undefined, // 确保不要报错
          url: opt.url
        }, loadedLength);*/
        var statusChangeTime = new Date();
        updateInterfaceState({
          url:opt.url,
          status:'success',//回调方式
          statusChangeTime:statusChangeTime,//状态更新时间
          statusChangeTimeString:statusChangeTime.toTimeString()//状态改变时间戳
        });
        //TBD cperformance.groupEnd(uuidXhrSend);
        opt.callback(res);
      },
      //错误
      error: function (err) {
        //cperformance.groupEnd(uuidXhrSend);
        if (opt.error) {
          opt.error(err);
        }
        var statusChangeTime = new Date();
        updateInterfaceState({
          url:opt.url,
          status:'error',//回调方式
          statusChangeTime:statusChangeTime,//状态更新时间
          statusText:err &amp;&amp; err.statusText,//错误状态码
        });
      }
    };
    //是否是跨域则加上这条
    if (opt.url.indexOf(window.location.host) === -1) {
      obj.crossDomain = !!opt.crossDomain;
    }
    var requestDate = new Date();
    Kai._interfaceStatesStore.put({
      id:opt.url,
      loadedLength:loadedLength,
      status:'加载中',
      requestTime:requestDate
    });
    return $.ajax(obj);
  }

  /**
   * ie 调用 crors
   */
  function _iecros(opt) {
    if (window.XDomainRequest) {
      var xdr = new XDomainRequest();
      if (xdr) {
        if (opt.error &amp;&amp; typeof opt.error == "function") {
          xdr.onerror = function () {
            opt.error();
          };
        }
        //handle timeout callback function
        if (opt.timeout &amp;&amp; typeof opt.timeout == "function") {
          xdr.ontimeout = function () {
            opt.timeout();
          };
        }
        //handle success callback function
        if (opt.success &amp;&amp; typeof opt.success == "function") {
          xdr.onload = function () {
            if (opt.dataType) {//handle json formart data
              if (opt.dataType.toLowerCase() == "json") {
                opt.callback(JSON.parse(xdr.responseText));
              }
            } else {
              opt.callback(xdr.responseText);
            }
          };
        }

        //wrap param to send
        var data = "";
        if (opt.type == "POST") {
          data = opt.data;
        } else {
          data = $.param(opt.data);//序列化URL get请求的url
        }
        xdr.open(opt.type, opt.url);
        xdr.send(data);
      }
    }
  }

  /*
  获得对象
  */
  function _getCommonOpt(url, data, callback, error) {
    return {
      url: url,
      data: data,
      callback: callback,
      error: error
    };
  }

  return {
    get: get,
    post: post,
    jsonp: jsonp,
    cros: cros,
    form: form
  };
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
