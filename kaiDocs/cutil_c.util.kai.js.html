<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: cutil/c.util.kai.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: cutil/c.util.kai.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
@description 全局方法 Kai.命名空间直接使用
*/
define([
  'dstore/Memory',
  "ui/promptpop/ui.promptpop",
  'ui/alert/ui.alert',
  "data/store/c.common.store",
  'ui/loading/ui.loading'
], function (
  Memory,
  promptpop,
  Alert,
  CommonStore,
  Loading
) {
  var win = window;
  ///*
  var _confirm = new Alert();
  var _alert = new Alert();
  var loadingTimeoutHandlerId;
  var UserStore = CommonStore.UserStore.getInstance();
  //*/
  var Kai =_.extend(Kai||{},
    {
      store: new Memory({

      }),//for business level usage

      _store: new Memory({

      }),//for system level usage

      _interfaceStatesStore: new Memory({

      }),//for system level usage

      //viewStatesModel:null,

      /*是否实在mobile环境中*/
      isMobile: function () {
        return !!navigator.userAgent.match(/AppleWebKit.*Mobile.*/);
      },

      getIndexURL:function(){
        var href = location.href;
        var urlWithoutHash = Kai.getUrlWithoutHash(href);
        if(urlWithoutHash.indexOf('index.html') >= 0){
          return urlWithoutHash;
        }else{
          if(Kai.hasSlashEnd(href)){
            return urlWithoutHash + 'index.html';
          }else{
            return urlWithoutHash + '/index.html';
          }
        }
      },

      hasSlashEnd:function(){
        var href = location.href;
        var urlWithoutHash = Kai.getUrlWithoutHash(href);
        var hasSlashEnd = (function(){
          lastSlashIndex = _.lastIndexOf(location.href,'/');
          if(lastSlashIndex == urlWithoutHash.length - 1){
            return true;
          }else{
            return false;
          }
        })();
        return hasSlashEnd;
      },

      getUrlWithoutHash:function(){
        var hashIndex = location.href.indexOf('#');
        var urlWithoutHash;
        if(hashIndex >= 0){
          urlWithoutHash = location.href.substring(0, hashIndex);
        }else{
          urlWithoutHash = location.href;
        }
        return urlWithoutHash;
      },

      getViewPath: function(node) {
        var viewPath;
        if (Kai.viewCollectionData) {
          _.each(Kai.viewCollectionData, function(view) {
            if (view.node === node) {
              viewPath = view.id;
              return;
            }
          });
        }
        return viewPath;
      },

      /*直接替换URL不能再回退到上一页*/
      replaceViewHash: function (hashName) {
        var urlWithoutHash = Kai.getUrlWithoutHash();
        if(_.isString(urlWithoutHash)){
          location.replace(urlWithoutHash + '#' + hashName);
        }
      },

      /*直接替换URL不能再回退到上一页*/
      forwardWithQueryParams: function (viewName,opts) {
        var opts = opts || {};
        var queryObj = _.extend(Kai.getQueryObj(),opts.queryObj || {});
        if(_.isString(viewName)){
          Kai.forward(viewName + '?' + $.param(queryObj),opts);
        }
      },

      /*回到首页并刷新*/
      restart: function (hashName) {
        var urlWithoutHash = Kai.getUrlWithoutHash();
        window.location.href = urlWithoutHash;
      },

      /*刷新页面 保留hash值*/
      restartWithHash: function (hashName) {
        window.location.href = window.location.href;
      },

      getHashFragment: function () {
        var hashIndex = window.location.href.indexOf('#');
        var urlLength = location.href.length;
        return location.href.substring(hashIndex + 1, urlLength);
      },

      /**
      * 框架自带getQuery有bug 比如?productid=111&amp;from=baidu.com%3Fa%3D1%26b%3D2时获取this.getQuery('from')居然是"baidu.com?a=1", 特此重写
      * @param  {String} queryKey query名
      * @return           返回query值或整个query对象
      */
      getQuery: function (queryKey) {
        var queryObj = this.getQueryObj();
        if (queryKey != null) {
          queryKey = queryKey.toLowerCase();
          return queryObj != null ? queryObj[queryKey] : null;
        }
        return queryObj;
      },

      /*查询对象*/
      getQueryObj: function () {
        var query = {};
        var href;
        href = window.location.href;
        var arr = href.search(/\?/) > -1 ? href.substr(href.search(/\?/) + 1).replace('?','&amp;').split('&amp;') : [];
        for (var i = 0; i &lt; arr.length; i++) {
          var key = decodeURIComponent(arr[i].split('=')[0]);
          var val = decodeURIComponent(arr[i].split('=')[1]);
          key = key.toLowerCase();
          if (key != null &amp;&amp; val != null) {
            query[key] = val;
          }
        }
        return query;
      },

      /*将对象数据生成URL参数*/
      toUrlString: function (obj) {
        var str = '';
        _.each(obj, function (val, key) {
          val = val == null ? '' : val;
          str += key + '=' + val + '&amp;';
        })
        str.substr(0, str.length - 1);
        return str;
      },

      /*对一个节点一次绑定多个事件*/
      bind: function (opts) {
        var view = this;
        for (var event in opts) {
          var eventArray = event.split(' ');
          var eventName = _.initial(eventArray).join(' ');
          var selector = _.last(eventArray);
          (function (opts, selector, eventName, view, event) {
            view.$el.find(selector).on(eventName, function (e) {
              opts[event] &amp;&amp; opts[event].call &amp;&amp; opts[event].call(view, e);
            })
          })(opts, selector, eventName, view, event)
        }
      },

      showErrorTip:function(params){
        var self = this;
      },

      hideErrorTip:function(){
        var self = this;
        $('.js_tooltips').hide();
      },

      showLoading: function (params) {
        var self = this;
        var params = params || {};
        var loadingElement;
        if(params.view &amp;&amp; params.view.$el){//if shown in a view
          //loadingElement = params.view.$el.children().filter('.cui_loading');
          loadingElement = params.view.$el.find('>.cui_loading');
          if(loadingElement.length &lt;= 0){
            params.view.loadingInstance = new Loading({
                container:params.view.$el
            });
            params.view.loadingInstance.display();
            return true;
          }else{
            //
            params.view.loadingInstance.reshow(_.extend({
                container:params.view.$el
            },params));
            return true;
          }
        }else{
          loadingElement = $('.cui_loading.index');//
        }
        if (loadingElement.length > 0) {
          //TBD
          clearTimeout(loadingTimeoutHandlerId);
          //修复问题 在页面加载和全局加载同时出现的时候
          $('.cui_loading:visible').hide();//将局部loading隐藏掉
          loadingElement.show();
          var UIID = _.uniqueId();
          loadingElement.data('UIID',UIID);
          loadingTimeoutHandlerId = _.delay(function(){
            if(loadingElement &amp;&amp; loadingElement.length > 0 &amp;&amp; (loadingElement.data('UIID') == UIID)){
              self.hideLoading();
            }
          },75000);
          //$('.loading-shade').show();
        } else {
          /*
          var loadingInstance = new loading({});
          loadingInstance.display();
          */
        }
      },
      /**
       * @see Kai.showLog
       * @deprecated
       */
      showLog: function (params) {
        var self = this;
        var text;
        if(_.isObject(params)){
          text = params.text;
        }else if(_.isString(params)){
          text = params;
        }
        var logElement = $('.cui_log');
        logElement.css("display","block");
        logElement.html(text);
        setTimeout(function(){
          logElement.fadeOut("slow");
        },5000);
      },

      /**
      * @see Kai.showToast
      * @deprecated
      */
      showToast: function (params) {
        //Kai.showToast(params);
        var self = this;
        var text;
        var stateStyle;
        var closeTime;
        var callback;
        self.hideLoading();
        if(_.isObject(params)){
          text = params.text;
          stateStyle = params.stateStyle;
          closeTime = params.closeTime || 2000;
          callback = params.callback || _.noop;
        }else if(_.isString(params)){
          text = params;
        }
        var promptpopInstance = new promptpop({});
        promptpopInstance.display({
          'text': '' + text,//显示内容
          'textClass': 'popTextColor',//添加的类
          'closeTime': closeTime || 2000,//关闭时间
          'callback': callback,//隐藏toast时的回调函数
          'stateStyle': stateStyle,//TBD necessary?
        });
      },

      /*
      * @see Kai.showLoading
      * @hideLoading
      */
      hideLoading: function (view) {
        if(view){
          if(view.$el &amp;&amp; (view.$el.find('>.cui_loading').length > 0)){
            view.$el.find('>.cui_loading').hide();
          }
        }else{
          if ($('body').find('>.cui_loading').length > 0) {
            $('body').find('>.cui_loading').hide();
          } else {
          }
        }
      },

      /**
      * 显示确认框
      * @param {string|Object} param 需要弹出的信息
      * @method Kai.showConfirm
      * @see Kai.showMessage
      */
      showConfirm: function (params) {
        if (!params) {
          params = {};
        }
        if (typeof params == 'string') {
          params = {
            datamodel: {
              content: params
            }
          };
        }
        _confirm.resetDefaultProperty();
        //与showMessage不一样的地方
        _confirm.datamodel.btns = [
          { name: '取消', className: 'cui-btns-cancel' },
          { name: '确定', className: 'cui-btns-ok' }
        ];
        _confirm.setOption(params);
        _confirm.show();
        _confirm.refresh();
      },

      /**
      * 隐藏确认框
      * @method Kai.hideConfirm
      */
      hideConfirm: function () {
        _confirm.hide();
      },

      showAlert:function(params){
        this.showMessage(params);
      },

      //单例模式
      showMessage: function (params) {
        if (!params) {
          params = {};
        }
        if (typeof params == 'string') {
          params = {
            datamodel: {
              content: params
            }
          };
        }

        //每次需要重置属性，以防组件互相影响
        _alert.resetDefaultProperty();
        _alert.setOption(params);
        _alert.show();
        _alert.refresh();
      },

      /**
      * 隐藏由showMessage弹出的消息
      * @method Lizard.hideMessage
      */
      hideMessage: function () {
        _alert.hide();
      },

      /*global config for specific project start*/
      getEnv:function(){
        var isH5 = (function() {
          var check = false;
          (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
          return check;
        })();
        return {
          isH5:isH5
        }
      },

      /*
      获取各个页面的状态
      */
      getViewState: function (viewId) {
        var viewModel = Kai.views.get(viewId);
        var viewInstance = viewModel &amp;&amp; viewModel.get('viewInstance');
        if (viewInstance) {
          return viewInstance.fsm.current;
        }
      },

      /*
      获得各个请求的状态
      */

      //emptyStore for every store
      emptyLocalStore: function(Stores){
        var storeNamesArray =  _.keys(Stores);
        _.each(storeNamesArray,function(storeName){
          if(storeName &amp;&amp; _.isString(storeName) &amp;&amp; storeName.indexOf('_') &lt; 0 &amp;&amp; Stores[storeName].getInstance){
            var storeItem = Stores[storeName].getInstance();
            storeItem.remove();
          }
        });
      },

      app:{
        code:{
          is:function(envCode){
            if(_.isObject(Kai.env) &amp;&amp; (Kai.env.envCode == envCode)){
              return true;
            }else{
              return false;
            }
          }
        }
      },

      sendUbt:function(viewObj/*or obj*/,sendData,opts){
        var self = this;
        if(_.isObject(viewObj) &amp;&amp; viewObj.fsm){
          var userStoreData = UserStore.get();
          if(!_.isObject(userStoreData)){
            return false;
          }
          var commonInfo = {
            uid:(userStoreData.user || {}).username,
            view:viewObj.viewName
          };
          var ubtData = viewObj.ubtData;
          var presetData = _.extend(commonInfo,ubtData);
          // 创建一个 self.viewName 统计模块的实例
          if(!opts){
            alog('UBT.send',"UBT",_.extend(presetData,sendData));
          }else if(opts &amp;&amp; opts.type){
            // 创建一个 self.viewName 统计模块的实例
            alog(opts.type + '.send',opts.type,_.extend(presetData,sendData));
          }else{
            /*
            alog('VL.send',obj.viewName, _.extend({
              current:obj.fsm.current//当前页面状态
            },userInfo));
            */
          }
        }
      },

      //判断是否登录
      isLogin:function(){
        var userStoreData = UserStore.get();//用户信息
        var HeadStore;
        var headInfo;//头部信息
        if(Kai.isH5){//只使用HeadStore判断
          HeadStore = CommonStore.HeadStore.getInstance();//
          headInfo = HeadStore.get();
          return _.isObject(headInfo) &amp;&amp; !_.isEmpty(headInfo) &amp;&amp; !!headInfo.auth;
        }else{//pc 环境
          return _.isObject(userStoreData) &amp;&amp; !_.isEmpty(userStoreData) &amp;&amp; !!userStoreData.auth;
        }
      },
      //http协议
      protocol:function(){
        var self = this;
        return window.location.protocol.indexOf("https") > -1 ? "https" : "http"
      },
      //回退
      back:function(){
        var self = this;
        history.go(-1);//back to last page when not login
      }
    }
  );
  win.Kai = Kai;
  return Kai;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Util.cUtilData.CData.html">Util.cUtilData.CData</a></li><li><a href="Util.cUtilDate.CDate.html">Util.cUtilDate.CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="topic_c.topic.html">topic/c.topic</a></li><li><a href="Util.cUtilCacheViews.html">Util.cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">Util.cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Util.cUtilCryptBase64.Base64</a></li><li><a href="Util.cUtilCryptRSA.html">Util.cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">Util.cUtilDate</a></li><li><a href="Util.cUtilObject.html">Util.cUtilObject</a></li><li><a href="Util.cUtilPath.html">Util.cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">Util.cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">Util.cUtilValidate</a></li><li><a href="Util.dgrid.html">Util.dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 18:08:16 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
