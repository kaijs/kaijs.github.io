<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: data/store/common/c.user.store.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: data/store/common/c.user.store.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @File c.user.store.js
 * @description  用户数据Store
 */

define([
  "common/c.class.inherit",
  "data/storage/c.local.storage",
  'data/store/c.local.store',
  "../c.session.store",
  "cutil/c.util.common",
  "data/store/common/c.head.store"
],
  function (
    cCoreInherit,
    cLocalStorage,
    cLocalStore,
    cSessionStore,
    cUtilCommon,
    cHeadStore
  ) {

  var ls = cLocalStorage.localStorage;
  /**
   * 用户数据Store,同时操作USER和USERINFO, 其中USERINFO是兼容老的数据格式,可以去掉.
   * 大部分的操作，已封装至cMemberService,
   * @namespace Store.cCommonStore.cUserStore
   * @example 使用方式
   *  var userStore = UserStore.getInstance();
   * @example 数据格式为
   * {
   *  "Address": "",
   *  "Auth": "E82047658BD3D8321E1EEB0F7F5D63EB1A5566AA70098AFE847505E34BD8BD5B",
   *  "Birthday": "19920624",
   *  "BMobile": "13814555555",
   *  "Email": "",
   *  "Experience": 106663,
   *  "ExpiredTime": "/Date(-62135596800000-0000)/",
   *  "Gender": 1,
   *  "IsNonUser": false,
   *  "LoginName": "",
   *  "Mobile": "13814555555",
   *  "PostCode": "",
   *  "UserID": "21634352BAC43044380A7807B0699491",
   *  "UserName": "ggggg",
   *  "VipGrade": 30,
   *  "VipGradeRemark": "钻石贵宾"
   * }
   */
  var UserStore = new cCoreInherit.Class(cSessionStore, {
    __propertys__: function () {
      /**
       * Store Key值为USER
       * @readonly
       * @var {string} [Store.cCommonStore.cUserStore.key=USER]
       */
      this.key = 'USER';

      /**
       * Store数据过期时间，默认为30D
       * @var {string} [Store.cCommonStore.cUserStore.lifeTime=30D]
       */
      this.lifeTime = '0.5D';
    },
    /*
     * @method cCommonStore.UserStore.initialize
     * @param $super
     * @param options
     * @description 复写自顶层Class的initialize，赋值队列
     */
    initialize: function ($super, options) {
      if(_.isFunction($super)){
        $super(options);
      }
    },

    /**
     * 返回用户信息
     * @method Store.cCommonStore.cUserStore.getUser
     * @param Function callback 强制去取用户信息
     * @returns {Object} userinfo 用户信息
     * @example 格式为
     * value": {
		 *    "Address": "",
		 *    "Auth": "CF7D8226D139CF771E2C860CA32EDEA01DDD8DDF07B72BB372B5C8726F718475",
		 *    "Birthday": "20071211",
		 *    "BMobile": "13814555555",
		 *    "Email": "",
		 *    "Experience": 106663,
		 *    "ExpiredTime": "/Date(-62135596800000-0000)/",
		 *    "Gender": 1,
		 *    "IsNonUser": false,
		 *    "LoginName": "",
		 *    "Mobile": "13814555555",
		 *    "PostCode": "",
		 *    "UserID": "21634352BAC43044380A7807B0699491",
		 *    "UserName": "呵呵呵呵呵呵",
		 *    "VipGrade": 30,
		 *    "VipGradeRemark": "钻石贵宾"
		 * }
     * @deprecated cServiceMember.getUser
     */
    getUser: function (callback) {
      if(_.isFunction(callback)){
        //如果有回调函数，则使用回调函数强制获取用户信息
        var scop = this;
        /*
        require(['cUserModel'],function (UserModel) {
          //获取用户信息成功回调
          var sucCb = function (data) {
            //获取信息成功才替换本地用户信息
            if(data.UserID){
              data.LoginName = data.LoginName || "";
              if(data.ResponseStatus){
                delete data.ResponseStatus;
                delete data.Result;
              }
              data.Auth = data.Auth ? data.Auth : cookieAuth;
              scop.setUser(data);
              if(new Date(data.ExpiredTime) != "Invalid Date"){
                scop.setExpireTime(data.ExpiredTime);
              }
            }
            callback(scop.getUser());
          };
          //获取用户信息成功回调
          var errCb = function () {
            callback(scop.getUser());
          };
          var cookieAuth = cUtilCommon.getCookie("authkey");
          if(cookieAuth){
            scop.setAuth(cookieAuth);
            var userModel = UserModel.GetUserModel.getInstance();
            userModel.param = {
              'Auth': cookieAuth
            };
            userModel.checkAuth = false; //cookie方式登陆下，不自动跳转到登录页面
            userModel.excute(sucCb, errCb);
          }
        });
        */
      }else{
        //如果没有回调，还走老的方式
        var userinfo = ls.oldGet('USERINFO');
        userinfo = userinfo &amp;&amp; userinfo.data || null;
        if (userinfo) {
          this.set(userinfo);
        }
        return userinfo || this.get();
      }
    },

    /**
     * 保存用户信息
     * @method Store.cCommonStore.cUserStore.setUser
     * @param {Object}  data UserInfo用户信息
     */
    setUser: function (data) {
      this.set(data);
      var timeout = ls.getExpireTime('USER');
      var userinfo = { data: data, timeout: timeout };
      ls.oldSet('USERINFO', JSON.stringify(userinfo));
    },

    /**
     * 移除用户信息，只清空本地登录状态
     * @method Store.cCommonStore.cUserStore.removeUser
     * @description 建议使用cMemberService.logout
     */
    removeUser: function () {
      ls.oldRemove('USERINFO');
      this.remove();
    },

    /**
     * 返回当前用户是否是未注册用户
     * @method Store.cCommonStore.cUserStore.isNonUser
     * @returns {boolean} isNonUser 返回当前用户是否是未注册用户
     * @deprecated
     */
    isNonUser: function () {
      var user = this.getUser();
      return false;
      //return user &amp;&amp; !!user.IsNonUser;
    },

    /**
     * 判断当前用户是否登陆
     * @method UserStore.isLogin
     * @returns {Object|boolean} isLogin 当前用户是否登陆
     * @deprecated 建议使用memberService.isLogin代替
     */
    isLogin: function () {
      var user = this.getUser();
      return user &amp;&amp; !!user.Auth ;
      //&amp;&amp; !!user['X-Sso-Token'] &amp;&amp; !user.IsNonUser
    },

    /**
     * 返回当前登陆用户的用户名
     * @method Store.cCommonStore.cUserStore.getUserName
     * @returns {String} UserName 用户名
     * @deprecated 建议使用cMemberService.getUserName代替
     */
    getUserName: function () {
      var user = this.getUser();
      return user &amp;&amp; user.UserName; //add by byl 此处支持localstorage中的user信息被删除
    },

    /**
     * 返回当前登陆用户的ID
     * @method Store.cCommonStore.cUserStore.getUserId
     * @returns {*|string} userId 用户Id
     */
    getUserId: function () {
      var user = this.getUser() || {};
      return user.UserID || cUtilCommon.getGuid();
    },

    /**
     * @method Store.cCommonStore.cUserStore.getAuth
     * @returns {*|string}
     * @description 返回当前登陆用户的Auth值
     */
    getAuth: function () {
      var userinfo = this.getUser();
      return userinfo &amp;&amp; userinfo.Auth;
    },

    /**
     * @method Store.cCommonStore.cUserStore.setAuth
     * @param {String} auth 用户auth字段
     * @description 返回当前登陆用户的Auth值
     * @
     */
    setAuth: function (auth) {
      var isLogin = this.isLogin(),
        userinfo = this.getUser() || {};
      userinfo.Auth = auth;
      userinfo['X-Sso-Token'] = auth;
      userinfo.IsNonUser = isLogin ? false : true;
      this.setUser(userinfo);
    },
    /**
     * @method Store.cCommonStore.cUserStore.setThirdParts
     * @param {Object} membersInfo 所有第三方用户信息
     * @description 存储当前用户所有的第三方登录信息
     */
    setThirdParts:function(membersInfo){
      var isLogin = this.isLogin(),
        userinfo = this.getUser() || {};
      //此过程中如果退出登录的话，不写入第三方用户信息
      if(!isLogin || !membersInfo){
        return;
      }
      userinfo.thirdParts = membersInfo;
      this.setUser(userinfo);
    },
    /**
     * @method Store.cCommonStore.cUserStore.setThirdPartsNull
     * @description 删除当前缓存中的第三方信息
     */
    setThirdPartsNon:function(){
      var isLogin = this.isLogin(),
        userinfo = this.getUser() || {};
      //此过程中如果退出登录的话，不写入第三方用户信息
      if(!isLogin){
        return;
      }
      userinfo.thirdParts = "";
      this.setUser(userinfo);
    },
    /**
     * @method Store.cCommonStore.cUserStore.getThirdParts
     * @description 获取当前用户的所有的第三方登录信息
     */
    getThirdParts:function(){
      var userinfo = this.getUser();
      return userinfo &amp;&amp; userinfo.thirdParts;
    },
    /**
     * @method Store.cCommonStore.cUserStore.getThirdPart
     * @param {String} thirdPartType 必填，所有第三方用户信息
     * @description 获取当前用户的某个第三方登录信息
     */
    getThirdPart:function(thirdPartType){
      var userinfo = this.getUser();
      if(thirdPartType &amp;&amp; userinfo &amp;&amp; userinfo.thirdParts &amp;&amp; userinfo.thirdParts.length > 0){
        var thirdParts = userinfo.thirdParts;
        return _.find(thirdParts,function(item){
          if(item.ThirdPartType == thirdPartType){
            return item;
          }
        });
      }
    },
    /**
     * @method Store.cCommonStore.cUserStore.setNonUser
     * @param {String} auth 用户auth
     * @description 设置当前用户为非注册用户
     */
    setNonUser: function (auth) {
      var HeadStore = cHeadStore.getInstance();
      HeadStore.setAttr('auth', auth);
      var data = {};
      data.Auth = auth;
      data.IsNonUser = true;
      this.setUser(data);
    },

    /**
     * @method Store.cCommonStore.cUserStore.setExpireTime
     * @param $super
     * @param timeout
     * @description 设置过期时间，同时会操作USERINFO
     */
    setExpireTime: function ($super, timeout) {
      $super(timeout);
      var data = this.get();
      var userinfo = { data: data, timeout: timeout };
      ls.oldSet('USERINFO', JSON.stringify(userinfo));
    }


  });

  return UserStore;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
