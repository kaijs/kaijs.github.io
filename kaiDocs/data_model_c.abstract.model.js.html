<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: data/model/c.abstract.model.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: data/model/c.abstract.model.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @Description: Model抽象类，封装ajax访问
 */
define([
  "common/c.class.inherit",
  "common/c.ajax",
  "cutil/c.util.common",
  "cutil/c.util.path",
  'dojo/Deferred'
 ],
  function (
    cCoreInherit,
    cAjax,
    cUtilCommon,
    pathUtil,
    Deferred
  ) {
/**
 * Model抽象类，封装ajax访问, 该类不能直接被实例化
 * @class
 * @name cAbstractModel
 */
  var AbstractModel = new cCoreInherit.Class(/** @lends cAbstractModel.prototype */{

    __propertys__: function () {

      /**
       * 数据请求url, 必填
       * @name cAbstractModel#url
       * @type {string}
       */
      this.url = null;

      /**
       * 请求参数,必选
       * @name cAbstractModel#param
       * @type {object}
       */
      this.param = null;

      /**
       * 数据返回时的自定义格式化函数
       * @method cAbstractModel#dataformat
       * @type {function}
       */
      this.dataformat = null;

      /**
       * 可选，存放用于验证的函数集合
       * @name cAbstractModel#validates
       * @type {array}
       */
      this.validates = [];


      /**
       * 通讯协议,http/https,默认为``location.protocol``
       * @name cAbstractModel#protocol
       * @type {string}
       */
      this.protocol = (window.location.protocol.indexOf("https") > -1) ? "https" : "http";


      /**
       * 提交数据格式 json/form/jsonp, 默认json
       * @name cAbstractModel#contentType
       * @type {string}
       */
      this.contentType = AbstractModel.CONTENT_TYPE_JSON;
      /**
       * 数据提交方式,post/get， 默认post
       * @name cAbstractModel#method
       * @type {string}
       */
      this.method = 'POST';

      /**
       * 是否强制Ajax获取,
       * @name cAbstractModel#ajaxOnly
       * @type {boolean}
       */
      this.ajaxOnly = false;

      /**
       * 超时时间
       * @name cAbstractModel#timeout
       * @type {number}
       */
      this.timeout = 50000;

      //当前的ajax对象
      this.ajax = null;
      //是否主动取消当前ajax
      this.isAbort = false;

      //参数设置函数
      this.onBeforeCompleteCallback = null;

      //toString override
      this.toString = function(){
        return this.buildurl &amp;&amp; this.buildurl();
      },

      this.getUrl = this.toString
    },

    /**
     * 复写自顶层Class的initialize，赋值队列
     * @param {Object} options
     */
    initialize: function (options) {
      this.assert();
      for (var key in options) {
        this[key] = options[key];
      }
    },


    assert: function () {
//      if (this.url === null) {
//        throw 'not override url property';
//      }
//      if (this.param === null) {
//        throw 'not override param property';
//      }
    },

    /**
     * 设置model属性值
     * @param {string} key 属性名，如url,protocol
     * @param {object} val 属性值
     * @deprecated
     */
    setAttr:function(key,val){
      this[key] = val;
    },

    /**
     * @param {function} handler
     * @description  将返回数据毁掉函数放到队列中
     */
    pushValidates: function (handler) {
      if (typeof handler === 'function') {
        this.validates.push($.proxy(handler, this));
      }
    },
    /**
     * 设置提交参数的值，如只传key一个参数，则置
     * @param {string|object} key 参数
     * @param {object} val 参数值
     */
    setParam: function (key, val) {
      if (typeof key === 'object' &amp;&amp; !val) {
        this.param = key;
      } else {
        this.param[key] = val;
      }
    },
    /**
     * 获取model的查询参数
     * @returns {json|Store} param  查询参数
     */
    getParam: function () {
      var params;
      if(_.isObject(this.param)){  //model post请求参数只能为对象
        params = $.extend(true,{},this.param);
      }
      return params || {};
    },

    /**
     *  获得查询结果结果
     *  @returns {json|Store} result  查询结果
     */
    getResult: function () {
      return this.result;
    },
    /**
     * 获得查询结果结果，建议使用Model.cAbstractModel.getResult
     * @deprecated
     * @method Model.cAbstractModel.getResultStore
     * @returns {json|Store} result  查询结果
     * @see  cAbstractModel#getResult
     */
    getResultStore: function () {
      return this.getResult();
    },
    /**
     * 构建url请求地址，子类可复写，返回优先级为model.url是一个完整的url结构
     * @override
     * @example
     * var Model = CoreInherit.Class(cAbstractModel, {
     *   buildurl: function() {
     *     return Kai.restfullApi + this.url;
     *   }
     * });
     */
    buildurl: function () {
      var url = this.url;
      if (!cUtilCommon.isUrl(this.url)) {
        var domain = 'm.stackoverflow.cc',restfulApi = "";

        if( this.protocol == "http" &amp;&amp; Kai.restfullApi){
          restfulApi = Kai.restfullApi;
        }else if(this.protocol == "https" &amp;&amp; Kai.restfullApiHttps){
          restfulApi = Kai.restfullApiHttps;
        }

        if (restfulApi &amp;&amp; cUtilCommon.isUrl(restfulApi)) {
          domain = pathUtil.parseUrl(restfulApi).hostname;
        }

        url = this.protocol + '://' + domain + '/restapi' +  this.url;
      }

      return url;
    },

    //增加model url请求的后缀
    appendSuffix:function(url){
      //var cid = window.localStorage.getItem('GUID');
      var cid = cUtilCommon.getGuid();
      //如果h5,并且clienId为服务端下发
      if(!Kai.isHybrid &amp;&amp; !Kai.isInCtripApp &amp;&amp; cid &amp;&amp; cid.indexOf('-') &lt; 0){
        var segChar = url.indexOf('?')>-1 ? "&amp;":'?' ;
        url = url + segChar + '_fxpcqlniredt=' + cid;
      }
      return url;
    },

    _execute: function (onComplete, onError, scope, onAbort, params, _deferred, opts) {
     //scope &amp;&amp; scope.showLoading &amp;&amp; scope.showLoading();//TBD 是否每次请求都需要显示loading？
      // @description 定义是否需要退出ajax请求
      this.isAbort = false;

      // @description 请求数据的地址
      var url = this.appendSuffix(this.buildurl());

      var self = this;

      var __onComplete = $.proxy(function (data) {
        //保存服务请求日志
        // cLog.serverLog(self.buildurl(), self.getParam(), data);
        //scope &amp;&amp; scope.hideLoading &amp;&amp; scope.hideLoading(); //TBD hideLoading temporary
        if (this.validates &amp;&amp; this.validates.length > 0) {
          // @description 开发者可以传入一组验证方法进行验证
          for (var i = 0, len = this.validates.length; i &lt; len; i++) {
            var validates = this.validates[i](data);
            if ((typeof validates === 'boolean')) {
              if (!validates) {
                //_.isFunction(this.onBeforeCompleteCallback) &amp;&amp; this.onBeforeCompleteCallback(data);
                // @description 如果一个验证不通过就返回
                if (typeof onError === 'function') {
                  return onError.call(scope || this, data);
                } else {
                  return false;
                }
              }
            } else {
              if (validates &amp;&amp; validates.overdue) {
                memberLogin();
                return;
              }
            }
          }
        }
        //auth过期时，跳转到登录
        function memberLogin(){
          require([(Kai.app.vendor.is('CTRIP') || Kai.isHybrid) ? 'cHybridMember' : 'cWebMember'], function (Member) {
            Member.memberLogin({'param': 'from=' + encodeURIComponent(window.location.href)});
          });
        }
        // @description 对获取的数据做字段映射
        var datamodel = typeof this.dataformat === 'function' ? this.dataformat(data) : data;

        if (typeof this.onBeforeCompleteCallback === 'function') {
          this.onBeforeCompleteCallback(datamodel);
        }

        if (typeof onComplete === 'function') {
          onComplete.call(scope || this, datamodel, data);
        }

      }, this);

      var __onError = $.proxy(function (e) {
       scope &amp;&amp; scope.hideLoading &amp;&amp; scope.hideLoading();
        if (self.isAbort) {
          self.isAbort = false;

          if (typeof onAbort === 'function') {
            return onAbort.call(scope || this, e);
          } else {
            return false;
          }
        }

        if (typeof onError === 'function') {
          onError.call(scope || this, e);
        }

      }, this);

      // @description 从this.param中获得数据，做深copy
      var reqParams = params || this.getParam();
      if(!this._avoidEncapsulationBody){
        //设置contentType无效BUG，改动一，将contentType保存
        reqParams.contentType = this.contentType;
      }
      //scope &amp;&amp; scope.hideLoading &amp;&amp; scope.hideLoading();
      if (this.contentType === AbstractModel.CONTENT_TYPE_JSON) {//默认请求方式

        // @description 跨域请求
        return this.ajax = cAjax.cros(url, this.method, reqParams, __onComplete, __onError,this.timeout);
      } else if (this.contentType === AbstractModel.CONTENT_TYPE_JSONP) {

        // @description jsonp的跨域请求
        return this.ajax = cAjax.jsonp(url, reqParams, __onComplete, __onError,this.timeout);
      } else {

        // @description 默认post请求
        return this.ajax = cAjax.post(url, reqParams, __onComplete, __onError,this.timeout);
      }
    },

    /**
     * 发送数据请求数据
     * @param {Function} onComplete 取完的回调函数
     * @param {Function} onError 发生错误时的回调
     * @param {Boolean} [ajaxOnly] 可选，默认为false当为true时只使用ajax调取数据
     * @param {Object} [scope] 可选，设定回调函数this指向的对象
     * @param {Function} [onAbort] 可选，取消时会调用的函数
     */
    execute: function (onComplete, onError, scope, onAbort, params, _deferred) {
      var _deferred = new Deferred();
      this._execute(onComplete, onError, scope, onAbort, params,_deferred);
    },
    /**
     * 终止请求
     */
    abort: function () {
      this.isAbort = true;
      if(this.ajax &amp;&amp; this.ajax.abort){
        this.ajax.abort();
      }
    }

  });

  /**
   * Model的单例获取方式
   * @method cAbstractModel.getInstance
   * @returns {object}
   */
  AbstractModel.getInstance = function () {
    if (this.instance instanceof this) {//如果已经有实例存在，则返回实例，否则创建并保存实例
      return this.instance;
    } else {
      return this.instance = new this();//生成实例并保存到this.instance
    }
  };

  /**
   * JSON方式提交请求
   * @constants
   * @name cAbstractModel.CONTENT_TYPE_JSON
   */
  AbstractModel.CONTENT_TYPE_JSON = 'json';
  /**
   * FORM方式提交请求
   * @constants
   * @name cAbstractModel.CONTENT_TYPE_FORM
   */
  AbstractModel.CONTENT_TYPE_FORM = 'form';
  /**
   * JSONP方式提交请求
   * @constants
   * @name cAbstractModel.CONTENT_TYPE_JSONP
   */
  AbstractModel.CONTENT_TYPE_JSONP = 'jsonp';

  return AbstractModel;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
