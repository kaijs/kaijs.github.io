<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: data/model/c.user.model.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: data/model/c.user.model.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>﻿/*
 * @Description: 封装H5的用户登录操作
 */
/**
 */
define([
  "common/c.class.inherit",
  "data/model/c.model",
  "data/store/c.common.store",
  "cutil/c.util.common"
],
  function(cCoreInherit, cModel, CommonStore, cUtilCommon) {

    "use strict";

    var UserStore = CommonStore.UserStore.getInstance();
    var HeadStore = CommonStore.HeadStore.getInstance();

    var UserModel = {};
    /**
	   * 非会员登录
     * @class
     * @extends cModel
	   * @name cUserModel.NotUserLoginModel
     * @example
     * var NotUser = cUserModel.NotUserLoginModel;
     * NotUser.getInstance().excute();
	   */
    UserModel.NotUserLoginModel = new cCoreInherit.Class(cModel, /** @lends cUserModel.NotUserLoginModel.prototype */{
      __propertys__: function() {
        this.url = "/html5/Account/NonUserLogin";
        this.param = {};
        //this.baseurl = cModel.baseurl.call(this);
        this._abortres = {};
        this.isAbort = false;
      },

      initialize: function($super, options) {
        $super(options);
      },

      /**
       * @param {function} onComplete 取完的回调函
       * @param {function} onError 发生错误时的回调
       * @param {boolean} ajaxOnly 可选，默认为false当为true时只使用ajax调取数据
       * @param {boolean} scope 可选，设定回调函数this指向的对象
       * @param {function} onAbort 可选，但取消时会调用的函数
       * @description 向服务端做非会员登陆
       */
      excute: function(onComplete, onError, ajaxOnly, scope, onAbort) {
        //add by byl 此处添加，如果已经是非会员登录，则不重新调用非会员登录，并且执行成功的回调函数
        var userData = UserStore.getUser();
        if(userData &amp;&amp; !!userData.Auth){
          if(typeof onComplete === 'function'){
            onComplete.call(scope, UserStore.getUser());
          }
          return;
        }
        this.isAbort = false;
        // var url = 'http://' + this.baseurl.domain + this.url;
        var host = window.location.host;
        if(host == 'localhost' || host.match(/\.fat/i)){
          host = 'm.fat19.qa.nt.ctripcorp.com';
        }
        var url = 'http://' + host + this.url;

        var successCallback = function(data) {
          if (data.ServerCode == 1 &amp;&amp; data.Data) {
            UserStore.setUser(data.Data);

            if (typeof onComplete === 'function') {
              onComplete.call(scope, data);
            }
          } else {
            if (typeof onError === 'function') {
              onError.call(scope);
            }
          }
        };

        var errorCallback = function() {
          if (this.isAbort) {
            if (typeof onAbort === 'function') {
              onAbort.call(scope);
            }

            this.isAbort = false;
            return;
          }

          if (typeof onError === 'function') {
            onError.apply(scope, arguments);
          }
        };

        this._abortres = $.ajax({
          'type': 'get',
          'url': url,
          'dataType': 'json',
          'crossDomain': true,
          'success': $.proxy(successCallback, this),
          'error': $.proxy(errorCallback, this),
          'timeout': 25000
        });
      },

      /**
       * 终止请求
       */
      abort: function() {
        this.isAbort = true;
        if (this._abortres &amp;&amp; typeof this._abortres.abort === 'function') {
          this._abortres.abort();
        }
      }
    });

    /**
     * 用户登录model
     * @class
     * @extends cModel
     * @name cUserModel.UserLoginModel
     * @example
     * var UserLogin = cUserModel.UserLoginModel;
     * UserLogin.getInstance().excute();
     */
    UserModel.UserLoginModel = new cCoreInherit.Class(cModel, /** @lends cUserModel.UserLoginModel.prototype*/ {
      __propertys__: function() {
        this.param = {};
        this.contentType = "jsonp";
        this.url = 'CrossDomainGetTicket/ajax/ajaxgetticket.ashx';
        this._abortres = {};
        this.isAbort = false;
      },
      initialize: function($super, options) {
        $super(options);
      },
      buildurl:function(){
        var host = window.location.host,
          domain = "accounts.ctrip.com";
        if (host.match(/^m\.ctrip\.com/i)){
          domain = "accounts.ctrip.com";
        }else if (host.match(/\.uat\.qa/i)){
          domain = "accounts.uat.qa.nt.ctripcorp.com";
        }else if (host.match(/\.fat/i) || (host.match(/\.lpt/i))|| host.match(/\.fws/i) || host.match(/^(localhost|172\.16|127\.0)/i)) {
          domain = "accounts.fat49.qa.nt.ctripcorp.com";
        }
        return ['https://',domain, '/',this.url].join("");
      },
      //重写此处的jsonP请求
      excute: function(onComplete, onError, ajaxOnly, scope, onAbort) {
        this.isAbort = false;
        var url = this.buildurl();
        var successCallback = function(info) {
          if (info.RetCode == '0' &amp;&amp; info.UserData) {
            if (typeof onComplete === 'function') {
              onComplete.call(scope, info.UserData);
            }
          } else {
            if (typeof onError === 'function') {
              onError.call(scope);
            }
          }
        };
        var errorCallback = function() {
          if (this.isAbort) {
            if (typeof onAbort === 'function') {
              onAbort.call(scope);
            }
            this.isAbort = false;
            return;
          }
          if (typeof onError === 'function') {
            onError.apply(scope, arguments);
          }
        };

        this._abortres = $.ajax({
          'type': 'get',
          'url': url,
          'dataType': 'jsonp',
          'data':this.param,
          'crossDomain': true,
          'jsonpCallback': "callbackfn",
          'success': $.proxy(successCallback, this),
          'error': $.proxy(errorCallback, this),
          'timeout': 50000
        });
      },
      abort: function() {
        this.isAbort = true;
        if (this._abortres &amp;&amp; typeof this._abortres.abort === 'function') {
          this._abortres.abort();
        }
      }
    });

    /**
     * 用户第三方登录
     * @class
     * @extends cModel
     * @name cUserModel.ThirdPartInfoModel
     * @example
     * var ThirdPart = cUserModel.ThirdPartInfoModel;
     * ThirdPart.getInstance().excute();
     */
    UserModel.ThirdPartInfoModel = new cCoreInherit.Class(cModel,  /** @lends cUserModel.ThirdPartInfoModel.prototype*/ {
      /**
       * @private
       * @method cUserModel.ThirdPardMemberLogin.__propertys__
       * @returns void
       */
      __propertys__: function() {
        this.param = {};
        this.url = '10448/GetThirdPartMembers.json';
      },
      /**
       * @private
       * @method cUserModel.UserLoginModel.initialize
       * @param {function} $super
       * @param {object} options
       * @description 对象初始化工作
       * @returns void
       */
      initialize: function($super, options) {
        $super(options);
        this.baseurl = this.seturl();
      },
      /*
       * @method cUserModel.UserLoginModel.seturl
       * @description 获取用户登录页面的服务器地址，供内部使用
       */
      seturl:function(){
        var host = window.location.host,
          path = '/restapi/soa2/',
          domain = "m.ctrip.com";
        if (host.match(/^m\.ctrip\.com/i)){
          domain = "m.ctrip.com";
        }else if (host.match(/\.uat\.qa/i)){
          domain = "gateway.m.uat.qa.nt.ctripcorp.com";
        }else if (host.match(/(\.fws|\.fat|\.lpt|localhost|172\.16|127\.0)/i)){
          domain = "gateway.m.fws.qa.nt.ctripcorp.com";
        }
        return {
          'domain': domain,
          'path': path
        };
      },

      buildurl: function () {
        if (cUtilCommon.isUrl(this.url)) {
          return this.url;
        }
        //目前没有https的接口，需要考虑https下使用的可能性
        return [this.protocol,'://',this.baseurl.domain,this.baseurl.path,this.url].join("");
      }
    });

    /**
     * 获取clientId
     * @class
     * @extends cModel
     * @name cUserModel.ClientIdModel
     * @example
     * var ClientId = cUserModel.ClientIdModel;
     * ClientId.getInstance().excute();
     */
    UserModel.ClientIdModel = new cCoreInherit.Class(cModel, /** @lends cUserModel.ClientIdModel.prototype*/{
      /**
       * @private
       * @method cUserModel.ThirdPardMemberLogin.__propertys__
       * @returns void
       */
      __propertys__: function() {
        this.param = {
          systemcode : '09',
          createtype: 3
        };
        this.method = 'get';
        this.url = '10290/createclientid';
      },
      /**
       * @private
       * @method cUserModel.UserLoginModel.initialize
       * @param {function} $super
       * @param {object} options
       * @description 对象初始化工作
       * @returns void
       */
      initialize: function($super, options) {
        $super(options);
        this.baseurl = this.seturl();
      },
      /*
       * @method cUserModel.UserLoginModel.seturl
       * @description 获取用户登录页面的服务器地址，供内部使用
       */
      seturl:function(){
        var host = window.location.host,
          path = '/restapi/soa2/',
          domain = "m.ctrip.com",
          isHttp = (this.protocol == "http")?true:false;
        if (host.match(/^(m|accounts|secure)\.ctrip\.com/i)){ //增加两个https下域名的处理
          if(isHttp){
            domain = "m.ctrip.com";
          }else{
            domain = "sec-m.ctrip.com";
          }
        }else if (host.match(/\.uat\.qa/i)){
          domain = "gateway.m.uat.qa.nt.ctripcorp.com"; //https和http下的地址是一样的
        }else if (host.match(/(\.fws|\.fat|\.lpt|localhost|172\.16|127\.0)/i)){
          domain = "gateway.m.fws.qa.nt.ctripcorp.com"; //https和http下的地址是一样的
        }
        return {
          'domain': domain,
          'path': path
        };
      },

      buildurl: function () {
        if (cUtilCommon.isUrl(this.url)) {
          return this.url;
        }
        //目前没有https的接口，需要考虑https下使用的可能性
        return [this.protocol,'://',this.baseurl.domain,this.baseurl.path,this.url].join("");
      }
    });

    /**
     * 根据auth获取用户信息,安全性较高的场景,请使用UserLoginModel
     * @class
     * @extends cModel
     * @name cUserModel.GetUserModel
     * @example
     * var GetUserModel = cUserModel.GetUserModel;
     * GetUserModel.getInstance().excute();
     */
    UserModel.GetUserModel = new cCoreInherit.Class(cModel, /** @lends cUserModel.GetUserModel.prototype*/{
      /**
       * @private
       * @method cUserModel.UserLoginModel.__propertys__
       * @returns void
       */
      __propertys__: function() {
        this.param = {};
        this.url = '10090/GetUserInfoToH5.json';
      },
      /**
       * @private
       * @method cUserModel.UserLoginModel.initialize
       * @param {function} $super
       * @param {object} options
       * @description 对象初始化工作
       * @returns void
       */
      initialize: function($super, options) {
        $super(options);
        this.baseurl = this.seturl();
      },
      /*
       * @method cUserModel.UserLoginModel.seturl
       * @description 获取用户登录页面的服务器地址，供内部使用
       */
      seturl:function(){
        var host = window.location.host,
          path = '/restapi/soa2/',
          domain = "m.ctrip.com";
        if (host.match(/^m\.ctrip\.com/i)){
          domain = "m.ctrip.com";
        }else if (host.match(/\.uat\.qa/i)){
          domain = "gateway.m.uat.qa.nt.ctripcorp.com";
        }else if (host.match(/(\.fws|\.fat|\.lpt|localhost|172\.16|127\.0)/i)){
          domain = "gateway.m.fws.qa.nt.ctripcorp.com";
        }
        return {
          'domain': domain,
          'path': path
        };
      },
      /*
       * 重写buildUrl
       * @returns {string}
       */
      buildurl: function () {
        if (cUtilCommon.isUrl(this.url)) {
          return this.url;
        }
        //目前没有https的接口，需要考虑https下使用的可能性
        return [this.protocol,'://',this.baseurl.domain,this.baseurl.path,this.url].join("");
      }
    });

    return UserModel;
  });
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
