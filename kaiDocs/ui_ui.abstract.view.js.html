<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ui/ui.abstract.view.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ui/ui.abstract.view.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>﻿/**
* @Description: UI组件基类
* @date 2014-10-09
* @version V1.0
*/

/**
* UI组件基类，提供一个UI类基本功能，并可注册各个事件点：
① onPreCreate 在dom创建时触发，只触发一次
② onCreate 在dom创建后触发，只触发一次
* @class
* @name UIView
* @example
* var ui = new UIView({
*   datamodel: {},
*   onShow: function() {},
*   onHide: function() {}
*   ...
* });
*/
define([
  "plugin/c.plugins"
], function () {

  /**
  * @description 闭包保存所有UI共用的信息，这里是z-index
  * @method getBiggerzIndex
  * @param {Number} level
  * @returns {Number}
  */
  var getBiggerzIndex = (function () {
    var index = 3000;
    return function (level) {
      return level + (++index);
    };
  })();

  var UIContainerUtil = (function () {
    //一个闭包对象存放所有实例化的ui实例
    var UIContainer = {};

    return {
      addItem: function (id, ui) {
        UIContainer[id] = ui;
      },

      removeItem: function (id) {
        if (UIContainer[id]){
        	  delete UIContainer[id];
        }
      },

      getItem: function (id) {
        if (id){
        	  return UIContainer[id];
        }
        return UIContainer;
      }
    };
  })();


  return _.inherit(/** @lends UIView.prototype */{

    /**
    * @description 设置实例默认属性
    * @method propertys
    */
    propertys: function () {
      //模板状态
      /**
       * UI组件根元素
       * @name UIView#wrapper
       */
      this.wrapper = $('body');
      /**
       * id标示器
       * @name UIView#id
       */
      this.id = _.uniqueId('ui-view-');

      /**
       * underscore模板,可以是字符串,打包的时候可以进行预编译
       * @name UIView#template
       * @type {string|function}
       */
      this.template = '';
      /**
       * 数据模板
       * @name UIView#datamodel
       * @type {object}
       */
      this.datamodel = {};
      /**
       * 事件对象
       * @name UIView#events
       * @type {object}
       */
      this.events = {};

      //自定义事件
      //此处需要注意mask 绑定事件前后问题，考虑scroll.radio插件类型的mask应用，考虑组件通信
      this.eventArr = {};

      /**
       * 初始状态为实例化
       * @name UIView#status
       */
      this.status = 'init';

      //要开启动画，需要配置以下3个属性
      this.needAnimat = false;
      this.animateShowAction = null;
      this.animateHideAction = null;

      //是否需要div包裹根元素
      this.needRootWrapper = true;
      // this.availableFn = function () { }
    },
    /**
     * 子类事件绑定若想保留父级的，应该使用该方法
     */
    addEvents: function (events) {
      if (_.isObject(events)){
      	_.extend(this.events, events);
      }
    },

    //阻止默认冒泡事件
    _preventDefault: function (e) {
      e.preventDefault();
    },

    /**
    * @description 绑定事件点回调，这里应该提供一个方法，表明是insert 或者 push，这样有一定手段可以控制各个同一事件集合的执行顺序
    * @param {String} type
    * @param {Function} fn
    * @param {Boolean} insert
    */
    on: function (type, fn, insert) {
      if (!this.eventArr[type]){
      	this.eventArr[type] = [];
      }

      //头部插入
      if (insert) {
        this.eventArr[type].splice(0, 0, fn);
      } else {
        this.eventArr[type].push(fn);
      }
    },

    /**
    * @description 移除某一事件回调点集合中的一项
    * @param {String} type
    * @param {Function} fn
    */
    off: function (type, fn) {
      if (!this.eventArr[type]){
      	return;
      }
      if (fn) {
        this.eventArr[type] = _.without(this.eventArr[type], fn);
      } else {
        this.eventArr[type] = [];
      }
    },

    /**
    * @description 触发某一事件点集合回调，按顺序触发
    * @param {String} type
    * @returns {Array}
    */
    //PS：这里做的好点还可以参考js事件机制，冒泡捕获处于阶段
    trigger: function (type) {
      var _slice = Array.prototype.slice;
      var args = _slice.call(arguments, 1);
      var events = this.eventArr;
      var results = [], i, l;

      if (events[type]) {
        for (i = 0, l = events[type].length; i &lt; l; i++) {
          results[results.length] = events[type][i].apply(this, args);
        }
      }
      return results;
    },

    /**
    * @description 创建dom根元素，并组装形成UI Dom树
    * @override 这里可以重写该接口，比如有些场景不希望自己创建div为包裹层
    * @method createRoot
    * @param {String} html
    */
    createRoot: function (html) {
      if (this.needRootWrapper) {
        this.$el = $('&lt;div class="view" style="display: none; " id="' + this.id + '">&lt;/div>');
        this.$el.html(html);
      } else {
        this.$el = $(html).hide().attr('id', this.id);
      }
    },

    /*

    */
    _isAddEvent: function (key) {
      if (key == 'onCreate' || key == 'onPreShow' || key == 'onShow' || key == 'onRefresh' || key == 'onHide'){
      	return true;
      }
      return false;
    },

    /**
    * @description 设置参数，重写默认属性
    * @override
    * @param {Object} options
    * @example
    * view.setOption({
    *   datamodel: {},
    *   events: {}
    * });
    * view.setOption({
    *   onCreate: function() {},
    *   onShow: function() {},
    *   onPreShow: function() {},
    *   onRefresh: function() {},
    *   onHide: function() {}
    * });
    */
    setOption: function (options) {
      //这里可以写成switch，开始没有想到有这么多分支
      for (var k in options) {
        if (k == 'datamodel' || k == 'events') {
          _.extend(this[k], options[k]);
          continue;
        } else if (this._isAddEvent(k)) {
          this.on(k, options[k]);
          continue;
        }
        this[k] = options[k];
      }
      //      _.extend(this, options);
    },

    /**
    * @description 构造函数
    * @param {Object} opts
    */
    initialize: function (opts) {
      this.propertys();
      this.setOption(opts);
      this.resetPropery();
      //添加系统级别事件
      this.addEvent();
      //开始创建dom
      this.create();
      this.addSysEvents();
      this.initElement();
      //将当前的ui实例装入容器
      UIContainerUtil.addItem(this.id, this);
    },

    //返回所有实例化的UI组件集合
    getUIContainer: function () {
      return UIContainerUtil.getItem();
    },

    //内部重置event，加入全局控制类事件
    addSysEvents: function () {
      if (typeof this.availableFn != 'function'){
      	return;
      }
      this.removeSysEvents();
      this.$el.on('click.system' + this.id, $.proxy(function (e) {
        if (!this.availableFn()) {
          e.preventDefault();
          if(e.stopImmediatePropagation){
          	e.stopImmediatePropagation();
          }
        }
      }, this));
    },

    removeSysEvents: function () {
      this.$el.off('.system' + this.id);
    },
    /**
     * 查找子元素
     */
    $: function (selector) {
      return this.$el.find(selector);
    },

    //提供属性重置功能，对属性做检查
    resetPropery: function () {
    },

    //各事件注册点，用于被继承
    addEvent: function () {
    },

    create: function () {
      this.trigger('onPreCreate');
      this.createRoot(this.render());
      this.status = 'create';
      this.trigger('onCreate');
    },

    //实例化需要用到到dom元素
    initElement: function () { },

    render: function (callback) {
      var data = this.getViewModel() || {};
      var html = this.template;
      if (!this.template){
      	return '';
      }
      if (data) {
        //引入预编译机制
        if (_.isFunction(this.template)) {
          html = this.template(data);
        } else {
          html = _.template(this.template)(data);
        }
      }
      if(typeof callback === 'function'){
      	callback.call(this);
      }
      return html;
    },
    /**
     * 刷新根据传入参数判断是否走onCreate事件
     * 这里原来的dom会被移除，事件会全部丢失 需要修复
     * @param {boolean}  needEvent 是否需要事件
     */
    refresh: function (needEvent) {
      this.resetPropery();
      if (needEvent) {
        this.create();
      } else {
        this.$el.html(this.render());
      }
      this.initElement();
      if (this.status == 'show'){
      	this.show();
      }
      this.trigger('onRefresh');
    },
    /**
     * 组件显示函数, 触发onPreShow， onShow事件
     * @example
     * view.show();
     */
    show: function () {
      if (!this.wrapper[0] || !this.$el[0]){
      	return;
      }
      //如果包含就不要乱搞了
      if (!$.contains(this.wrapper[0], this.$el[0])) {
        //如果需要清空容器的话便清空
        if (this.needEmptyWrapper){
        	  this.wrapper.html('');
        }
        this.wrapper.append(this.$el);
      }

      this.trigger('onPreShow');

      if (this.needAnimat &amp;&amp; (typeof this.animateShowAction == 'function') &amp;&amp; (this.animateInClass ? this.hasAnimationProperty(this.animateInClass) : (typeof this.animateShowAction == 'function')) &amp;&amp; this.status != 'show') {
        this.animateShowAction &amp;&amp; this.animateShowAction.call(this, this.$el);
      } else{
      	this.$el.show();
      }

      this.status = 'show';
      this.addSysEvents();
      this.bindEvents();
      this.trigger('onShow');
      if(this.needMask){

      }else{
        this.mask &amp;&amp; this.mask.hide();
      }
    },
    /**
     * 组件隐藏函数, 触发onPreHide， onHide事件
     * @example
     * view.hide();
     */
    hide: function () {
      if (!this.$el || this.status !== 'show'){
      	return;
      }
      this.trigger('onPreHide');

      if (this.needAnimat &amp;&amp; (this.animateOutClass ? this.hasAnimationProperty(this.animateOutClass) : (typeof this.animateShowAction == 'function')) &amp;&amp; this.status != 'hide') {
        this.animateHideAction.call(this, this.$el);
      } else{
      	this.$el.hide();
      }

      this.status = 'hide';
      this.unBindEvents();
      this.removeSysEvents();
      this.trigger('onHide');
    },

    //检测某class是否包含动画特性
    hasAnimationProperty: function (className) {
      var animateProprtys = [
      //有什么判断的便新增
        $.fx.cssPrefix + 'animation-name'
      ];
      var el = $('&lt;div>&lt;/div>');

      var i, len;

      //赋予其class
      el.attr('class', className);
      $('body').append(el);

      if (el.css(animateProprtys[0]) != 'none') {
        el.remove();
        return true;
      }
      el.remove();
      return false;
    },
    /**
     * UI组件销毁
     */
    destroy: function () {
      this.status = 'destroy';
      this.unBindEvents();
      this.removeSysEvents();
      UIContainerUtil.removeItem(this.id);
      this.$el.remove();
      this.trigger('onDestroy');
      delete this; // jshint ignore:line
    },

    getViewModel: function () {
      return this.datamodel;
    },

    setzIndexTop: function (el, level) {
      if (!el){
      	el = this.$el;
      }
      if (!level || level > 10){
      	level = 0;
      }
      level = level * 1000;
      el.css('z-index', getBiggerzIndex(level));

    },

    /**
    * 解析events，根据events的设置在dom上设置事件
    */
    bindEvents: function () {
      var events = this.events;

      if (!(events || (events = _.result(this, 'events')))){
      	return this;
      }
      this.unBindEvents();

      // 解析event参数的正则
      var delegateEventSplitter = /^(\S+)\s*(.*)$/;
      var key, method, match, eventName, selector;

      // 做简单的字符串数据解析
      for (key in events) {
        method = events[key];
        if (!_.isFunction(method)){
        	  method = this[events[key]];
        }
        if (!method){
        	 continue;
        }

        match = key.match(delegateEventSplitter);
        eventName = match[1];
        selector = match[2];
        method = _.bind(method, this);
        eventName += '.delegateUIEvents' + this.id;

        if (selector === '') {
          this.$el.on(eventName, method);
        } else {
          this.$el.on(eventName, selector, method);
        }
      }

      return this;
    },

    /**
    * 冻结dom上所有元素的所有事件
    *
    * @return {object} 执行作用域
    */
    unBindEvents: function () {
      this.$el.off('.delegateUIEvents' + this.id);
      return this;
    }
  });
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
