<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: kaiView/pc/view/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: kaiView/pc/view/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
页面名称：首页
作者：chenxiangyun01@company.com
assume viewData is already there
events is ready
考虑到首页本身逻辑比较通用，将首页放在框架层维护
更新页面展示
*/
define([
  "../viewUtils/index",
  "dijit/Tree",
  "data/store/c.common.store",
  "dojo/store/Memory",
  "dijit/tree/ObjectStoreModel",
  "../widget/dijit/views_states_dialog",
  "../widget/dijit/change_password_dialog",
  'page/viewFactory',
  "dijit/registry",
  "dojo/topic",
  "../events/index",
  "dojo/on",
  "dijit/Tree",
  "dijit/layout/TabContainer",
  "dijit/layout/BorderContainer",
  "dijit/layout/AccordionContainer",
  "dojox/layout/ExpandoPane",
  "dijit/Toolbar",
  "dojo/domReady!",
  "dojox/validate/web",
  "dijit/form/ValidationTextBox"
], function (
  viewUtils,
  Tree,
  CommonStore,
  Memory,
  ObjectStoreModel,
  views_states_dialog,
  Change_password_dialog,
  CommonPageFactory,
  _registry,
  topic,
  Events,
  on
) {
  "use strict";

  var baseview = CommonPageFactory.create('appBaseView');
  //Store
  var userStore = CommonStore.UserStore.getInstance();//纪录用户信息
  //View util methods

  var eventHandler = {

    /**
    *@description 生成左侧的导航树
    * @param {object} selector 选择器
    */
    createNavigationTree:function(items){
      var self = this;
      var items = (self.authRequired &amp;&amp; !(self.useLocalMenuTree))?(userStore.getAttr('menuTree')):items;//小贷将数据存放在这个地方
      self.store.setAttr('navigationItems',items);//存储导航栏
      if(!items || !_.isArray(items) ){
        //self.showLoginDialog();
        Kai.forward(Kai.loginUrl);
        return false;
      }

      _.map(items, function (menu) {
        if (!menu.parent) {
          menu.parent = 'root';
        }
      });

      //push a facke item to make a forest into tree
      items.push({id: 'root', name: 'root'});

      //create tree Store
      self.treeStore = new Memory({
        data: items,
        getChildren: function (object) {
          return this.query({parent: object.id});
        }
      });

      // Create the tree model
      self.treeModel = new ObjectStoreModel({
        store: self.treeStore,
        query: {id: 'root'},
        mayHaveChildren: function (item) {
          return !item.leaf;
        }
      });

      //创建导航树
      self.navTree = new Tree({
        id: 'rootlessTree' + self.contextPostfix,
        model: self.treeModel,//数据源
        showRoot: false,//显示根
        openOnClick: true,//点击后展开
        autoExpand: true//是否默认展开
      });

      self.navTree.placeAt(self.$el.find('#navigation')[0]);
      self.navTree.startup();
    },

    //change passowrd dialog show 显示修改密码弹窗
    showChangePasswordDialog: function () {
      var self = this;
      self.change_password_dialog = new Change_password_dialog({
        widgetData: {
        },
        view:self,
        force:!!userStore.getAttr('needChangePassword'),
        requireMD5Encrypt:self.requireMD5Encrypt
      });
      self.change_password_dialog.startup();
      self.change_password_dialog.show();
    },

    /*根据选择的widget实例化（显示）对应的view*/
    forwardToChildView: function (model, currentChildViewName, opts) {
      var self = this;
      if(!_.isString(currentChildViewName)){
        return false;
      }
      if(currentChildViewName.indexOf('pc/view') &lt; 0){
        currentChildViewName = currentChildViewName.replace('pc/','pc/view/');
      }
      $.proxy(eventHandler.selectChildWidget, self)(currentChildViewName);//
    },

/**选中对应的widget*/
selectChildWidget: function (viewName) {
  var self = this;
  if(!_.isString(viewName) || _.isEmpty(viewName)){
    return false;
  }
  var showTopTabs = function () {
    self.els.topTabs.domNode.style.display = 'block';//index level tab container
    //self.els.topTabs &amp;&amp; self.els.topTabs.resize();
  };
  var selectTab = function(){
    /*仍然不存在该子tab，添加子tab*/
    if (!_.contains(self.els.topTabs.getChildren(), targetWidget)) {
      self.els.topTabs.addChild(targetWidget);//add sub tabs
    } else {/*There is already one*/
      self.hideLoading();
    }
    self.els.topTabs.selectChild(self.registry.byId(viewName));//select the tab
  };

  showTopTabs();//show tab container

  var targetWidget = self.registry.byId(viewName);

  if (!targetWidget) {//the first time to show the tab. Need to create from template before show
    self.reparse(self.viewData, {
      templateFunctionId: viewName,
      clear: false,
      needDojoParse: true,
      callback: function () {
        //Kai.forward(viewName,{keepURL:true});
      }
    });

    _.defer(function(){
      targetWidget = self.registry.byId(viewName);
      if(targetWidget){
        targetWidget.isRecreated = true;//sign to mean the initialize is finished
        //destroy the view if the tab is closed
        on(targetWidget, 'close', function (parentWidget, childWidget) {
          //self.showLoading();
          var viewModel = Kai.views.findWhere({
            viewName: self.removeContextPostfix(childWidget.id)
          });
          if (viewModel &amp;&amp; _.isObject(viewModel)) {
            var viewInstance = viewModel.get('viewInstance');
            viewInstance &amp;&amp; viewInstance.destroy &amp;&amp; viewInstance.destroy();
          }
          self.model.unset('currentChildViewName',{silent:true});
        });
        //only when the tab is finish loading, shall we forward subView
        if(targetWidget.isLoaded){
          //self.showLoading();
          self.model.set('currentChildViewName',viewName,{silent:true});
          Kai.forward(viewName, {keepURL: true});
        }else{
          on(targetWidget, 'load', function () {
            //self.showLoading();
            self.model.set('currentChildViewName',viewName,{silent:true});
            Kai.forward(viewName, {keepURL: true});
          });
        }
        selectTab();//选择该tab 物理上显示
      }
    });
  } else {
    /**/
    if (!targetWidget.isRecreated) {//the widget is already there. viewInstance is already there
      //if the widget is closed. The coresponding view should be destroyed
      /*NOTE: it is here only for compatible*/
      on(targetWidget, 'close', function (parentWidget, childWidget) {//当某个tab关闭的时候 只有index 级别的tab可以关闭
        var viewModel = Kai.views.findWhere({viewName: self.removeContextPostfix(childWidget.id)});
        if (viewModel) {
          var viewInstance = viewModel.get('viewInstance');
          viewInstance &amp;&amp; viewInstance.destroy();
        }
        self.model.unset('currentChildViewName',{silent:true});
      });
      //the tab for the view is already there
      //self.showLoading();
      self.model.set('currentChildViewName',viewName,{silent:true});
      selectTab();
      Kai.forward(viewName, {keepURL: true});//TBD temp comment it
    }else{
      self.model.set('currentChildViewName',viewName,{silent:true});
      selectTab();
      Kai.forward(viewName, {keepURL: true});//TBD
    }
  }
},

//show login user's state
showUserInfo:function(){
  var self = this;
  var user = userStore.getAttr('user');
  if(_.isObject(user)){
    self.$el.find("#username_login").html("登录名:" + (user.chinesename || ''));
    self.$el.find("#position_login").html("职位:" + (user.stationname || ''));
  }else{
    //self.showLoginDialog();//TBD
  }
}
};

var View = baseview.extend({

  //elements used in this view
  els: {
    'main_container': {
      selector: 'pc/index'
    },
    'topTabs': {
      selector: 'pc_index_main_tab_container'
    },
    'rootlessNavTree': {
      selector: 'rootlessTree'
    },
    'logoutButton': {
      selector: 'pc/index_logout'
    },
    'changePassButton': {
      selector: 'pc/change_password'
    },
    'restartButton': {
      selector: 'pc/index_restart'
    },
    'refresh': {
      selector: 'pc/index_refresh'
    },
    'showCode': {
      selector: 'pc/show_code'
    },
    'reload': {
      selector: 'pc/index_reload'
    },
    'viewStatesButton': {
      selector: 'pc/index_button_view-states'
    },
    'interfacesStatesButton': {
      selector: 'pc/index_button_interfaces-states'
    },
    'navigation':{
      selector:'navigation'
    },
    'headerLogo':{
      type:'jquery',
      selector:'.header-logo'
    },
    'closeAllTabsButton':{
      selector:'pc/index_close-all-tabs'
    },
    'userInfo':{
      selector:'#userInfo',
      type:'jquery'
    }
  },

  //check if the view should be created
  triggerCreateCheck: function () {
    var self = this;
    if (self.authRequired &amp;&amp; !self.isLogin()) {
      self.triggerCreate = false;
      self.forward(Kai.loginUrl,{
        keepURL:true
      });
      return false;
    } else {
    return true;
  }
},

//life cycle
onCreate: function () {
  var self = this;
  //Kai.emptyLocalStore(Stores);//clear local storage
  // 导航配置 权限判断
  $.proxy(eventHandler.createNavigationTree,self)(self.menuTree);//create nav tree
},

/*prepare events*/
prepareEvents: function () {
  var self = this;
  self.event = Events;
},

/*prepare view data*/
prepareViewData: function () {
  var self = this;
  self.turnOn();
},

//lisent to model change
listenToModel: function () {
  var self = this;
  self.model.on({
    /*当前的viewname发生变化 index tab container下面的一级tab*/
    'change:currentChildViewName': $.proxy(eventHandler.forwardToChildView, self), /*切换到对应的tab*/
    'change:need_showViewsStatesDialog': $.proxy(viewUtils.showViewsStatesDialog, self),/*show view state*/
    'change:need_showInterfacesStatesDialog': $.proxy(viewUtils.showInterfacesStatesDialog, self),/*show view state*/
    'change:need_showChangePasswordDialog': $.proxy(eventHandler.showChangePasswordDialog, self),/*show view state*/
  });
},

//生成vue数据
getVueData:function(){
  var self = this;
  return {
    user:userStore.getAttr('user'),//登录用户信息
    version:dojo.config.cacheBust.match(/_v=(\w{0,}).{0,1}\w{0,}_k/)[1],//前端发布版本号
    headerTitle:self.headerTitle,//前端发布版本号
  };
},

//something need to be done when view is loaded and parsed
afterShow: function () {
  var self = this;
},

//onShow life cycle
onShow:function(){
  var self = this;
  if(!self.isFirstLoad){//restart view if login again
    window.onbeforeunload = null;
    Kai.restart();
    //self.reload();
    //$.proxy(eventHandler.createNavigationTree,self)();//create nav tree
  }
  if(userStore.getAttr('needChangePassword')){
    self.model.set('need_showChangePasswordDialog',true);
    self.model.unset('need_showChangePasswordDialog',{silent:true});
  }
  $.proxy(eventHandler.showUserInfo,self)();
  Kai.hideLoading();
  // 导航配置 权限判断
},

prepareViewUtils:function(){
  var self = this;
  self.viewUtils= viewUtils;
},

parseTempate:function(){//提前重新处理模版
  var self = this;
  var templateFn = _.template(
  "&lt;%_.each(indexLevelViewList,function(viewItem){%>" +
  "&lt;script type='text/template' style='display: none;' " +
  "data-templateFunctionid='&lt;%=viewItem.id%>' " +
  "data-dojo-id='&lt;%=viewItem.id%>' " +
  "class='kai_widget' data-parseonload='false' data-dojo-avoidreparse='true' data-avoidreparse='true'> " +
  "&lt;div> " +
  "&lt;a data-dojo-type='dijit/layout/LinkPane' " +
    "id='&lt;%=viewItem.id%>' " +
    "data-viewname='&lt;%=viewItem.id%>' data-dojo-props=\"preload:true,parseOnLoad:false,doLayout:false,style:'display:none;',closable:true, " +
    "title:'&lt;%=viewItem.title || viewItem.nodeName%>'\">" +
    "&lt;/a> " +
  "&lt;/div>" +
  "&lt;/script>"+
"&lt;%});%>"
);
var indexLevelViewList = _.filter(Kai.viewCollectionData,{ indexLevel:true});//underscorejs method find index level view
var appendedNodes = templateFn({
  indexLevelViewList:indexLevelViewList
});//TBD
self.$el.find('.viewContainer').append(appendedNodes);//update template to a destination one
},
//
onHide:function(){
    var self = this;
    self.hideLoading();
}
});
return View;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="-_checkSelectedDown.html">_checkSelectedDown</a></li><li><a href="-_checkSelectedUp.html">_checkSelectedUp</a></li><li><a href="c.ui.imageSlider.html">imageSlider</a></li><li><a href="cAbstractModel.html">cAbstractModel</a></li><li><a href="cAbstractStore.html">cAbstractStore</a></li><li><a href="cBase.html">cBase</a></li><li><a href="cCoreInherit.html">cCoreInherit</a></li><li><a href="cModel.html">cModel</a></li><li><a href="cPageList.html">cPageList</a></li><li><a href="cSessionStore.html">cSessionStore</a></li><li><a href="cStore.html">cStore</a></li><li><a href="cUIInputClear.html">cUIInputClear</a></li><li><a href="cUserModel.ClientIdModel.html">ClientIdModel</a></li><li><a href="cUserModel.GetUserModel.html">GetUserModel</a></li><li><a href="cUserModel.NotUserLoginModel.html">NotUserLoginModel</a></li><li><a href="cUserModel.ThirdPartInfoModel.html">ThirdPartInfoModel</a></li><li><a href="cUserModel.UserLoginModel.html">UserLoginModel</a></li><li><a href="Service.cGeo.Address.html">Address</a></li><li><a href="Service.cGeo.City.html">City</a></li><li><a href="Service.cGeo.Coordinate.html">Coordinate</a></li><li><a href="Service.cGeo.Geolocation.html">Geolocation</a></li><li><a href="Service.cGeo.Map.html">Map</a></li><li><a href="Service.cGeo.Map.Icon.html">Icon</a></li><li><a href="Service.cGeo.Map.Layer.html">Layer</a></li><li><a href="Service.cGeo.Map.Mark.html">Mark</a></li><li><a href="Service.cGeo.MapS.html">MapS</a></li><li><a href="Service.cGeo.POI.html">POI</a></li><li><a href="Service.cGeo.POIQuery.html">POIQuery</a></li><li><a href="UICalendarCommon.html">UICalendarCommon</a></li><li><a href="UIScroll.html">UIScroll</a></li><li><a href="UIView.html">UIView</a></li><li><a href="Util.cUtilData.CData.html">CData</a></li><li><a href="Util.cUtilDate.CDate.html">CDate</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_.dateUtil.html">dateUtil</a></li><li><a href="cAjax.html">cAjax</a></li><li><a href="Common.cMessageCenter.html">cMessageCenter</a></li><li><a href="Service.cGeo.html">Service.cGeo</a></li><li><a href="Storage.cAbstractStorage.html">cAbstractStorage</a></li><li><a href="Storage.cLocalStorage.html">cLocalStorage</a></li><li><a href="Storage.cMemoryStorage.html">cMemoryStorage</a></li><li><a href="Storage.cSessionStorage.html">cSessionStorage</a></li><li><a href="Store.cCommonStore.html">cCommonStore</a></li><li><a href="Store.cCommonStore.cHeadStore.html">cHeadStore</a></li><li><a href="Store.cCommonStore.cMobileTokenStore.html">cMobileTokenStore</a></li><li><a href="Store.cCommonStore.cUserStore.html">cUserStore</a></li><li><a href="Store.cMarketStore.html">cMarketStore</a></li><li><a href="Store.cMarketStore.SalesObjectStore.html">SalesObjectStore</a></li><li><a href="Store.cMarketStore.SalesStore.html">SalesStore</a></li><li><a href="Store.cMarketStore.UnionStore.html">UnionStore</a></li><li><a href="Store.cMemoryStore.html">cMemoryStore</a></li><li><a href="Util.cUtilCacheViews.html">cUtilCacheViews</a></li><li><a href="Util.cUtilCryptBase64.html">cUtilCryptBase64</a></li><li><a href="Util.cUtilCryptBase64.Base64.html">Base64</a></li><li><a href="Util.cUtilCryptRSA.html">cUtilCryptRSA</a></li><li><a href="Util.cUtilDate.html">cUtilDate</a></li><li><a href="Util.cUtilObject.html">cUtilObject</a></li><li><a href="Util.cUtilPath.html">cUtilPath</a></li><li><a href="Util.cUtilPerformance.html">cUtilPerformance</a></li><li><a href="Util.cUtilValidate.html">cUtilValidate</a></li><li><a href="Util.dgrid.html">dgrid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_stores%255Bundefined%255D">_stores[undefined]</a></li><li><a href="global.html#abort">abort</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#bindthis">bindthis</a></li><li><a href="global.html#buildurl">buildurl</a></li><li><a href="global.html#childViewNames">childViewNames</a></li><li><a href="global.html#clearResult">clearResult</a></li><li><a href="global.html#cPageView#onCreateopts%257B%257D">cPageView#onCreate
            opts {
          }</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#createRoot">createRoot</a></li><li><a href="global.html#excute">excute</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extension">extension</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAttr">getAttr</a></li><li><a href="global.html#getBiggerzIndex">getBiggerzIndex</a></li><li><a href="global.html#getCookieVal">getCookieVal</a></li><li><a href="global.html#getCreateId">getCreateId</a></li><li><a href="global.html#getCurStyleOfEl">getCurStyleOfEl</a></li><li><a href="global.html#getDirtyItems">getDirtyItems</a></li><li><a href="global.html#getElementPos">getElementPos</a></li><li><a href="global.html#getElementRealSize">getElementRealSize</a></li><li><a href="global.html#getExpireTime">getExpireTime</a></li><li><a href="global.html#getMousePosOfElement">getMousePosOfElement</a></li><li><a href="global.html#getPageScrollPos">getPageScrollPos</a></li><li><a href="global.html#getPageSize">getPageSize</a></li><li><a href="global.html#getParam">getParam</a></li><li><a href="global.html#getQuery">getQuery</a></li><li><a href="global.html#getResult">getResult</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#InputClear">InputClear</a></li><li><a href="global.html#isUseH5Sys">isUseH5Sys</a></li><li><a href="global.html#key">key</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#presetData">presetData</a></li><li><a href="global.html#propertys">propertys</a></li><li><a href="global.html#pushValidates">pushValidates</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeAttr">removeAttr</a></li><li><a href="global.html#rollback">rollback</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setAttr">setAttr</a></li><li><a href="global.html#setConfig">setConfig</a></li><li><a href="global.html#setExpireTime">setExpireTime</a></li><li><a href="global.html#setLifeTime">setLifeTime</a></li><li><a href="global.html#setParam">setParam</a></li><li><a href="global.html#showLog">showLog</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#strToNum">strToNum</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Oct 13 2016 13:38:14 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
